<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>JS vs WASM HSV ë¹„êµ</title>
  <style>
    body { font-family: system-ui, sans-serif; text-align: center; margin: 20px; }
    h2 { margin-bottom: 10px; }
    .flex-row { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
    .block { display: flex; flex-direction: column; align-items: center; }
    .controls { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    label { display: flex; align-items: center; gap: 10px; min-width: 320px; }
    input[type="range"] { width: 220px; }
    canvas {
      border: 1px solid #0002;
      margin-top: 10px;
      max-width: 480px;  /* ğŸ‘ˆ í™”ë©´ì— ë§ê²Œ ìë™ ì¶•ì†Œ */
      height: auto;
    }
    .perf { margin-top: 10px; font-size: 14px; color: #555; }
    .ok { color:#1a7f37; } .warn { color:#b54708; }
  </style>
</head>
<body>
  <h2>JS vs WASM HSV ë¹„êµ (í•œ í™”ë©´ìš©)</h2>

  <div class="controls">
    <input type="file" id="imgInput" accept="image/*" />
    <label>Hue:
      <input type="range" id="hue" min="0" max="360" value="0" />
      <span id="hueVal">0Â°</span>
    </label>
    <label>Saturation:
      <input type="range" id="sat" min="0" max="200" value="100" />
      <span id="satVal">100%</span>
    </label>
    <label>Value:
      <input type="range" id="val" min="0" max="200" value="100" />
      <span id="valVal">100%</span>
    </label>
  </div>

  <div class="flex-row">
    <div class="block">
      <h3>JS ê²°ê³¼</h3>
      <canvas id="canvasJS"></canvas>
      <div id="perfJS" class="perf">JS ì²˜ë¦¬ì‹œê°„: -</div>
    </div>
    <div class="block">
      <h3>WASM ê²°ê³¼</h3>
      <canvas id="canvasWASM"></canvas>
      <div id="perfWASM" class="perf warn">WASM ë¡œë”© ì¤‘â€¦</div>
    </div>
  </div>

  <script>
    var Module = {
      onRuntimeInitialized() {
        console.log("âœ… WASM Runtime Initialized");
        setupWASM();
      }
    };
  </script>
  <script>document.write(`<script src="hsv.js?v=${Date.now()}"><\/script>`);</script>

  <script>
    const imgInput = document.getElementById("imgInput");
    const hue = document.getElementById("hue");
    const sat = document.getElementById("sat");
    const val = document.getElementById("val");
    const hueVal = document.getElementById("hueVal");
    const satVal = document.getElementById("satVal");
    const valVal = document.getElementById("valVal");

    const canvasJS = document.getElementById("canvasJS");
    const ctxJS = canvasJS.getContext("2d", { willReadFrequently: true });
    const canvasWASM = document.getElementById("canvasWASM");
    const ctxWASM = canvasWASM.getContext("2d", { willReadFrequently: true });

    const perfJS = document.getElementById("perfJS");
    const perfWASM = document.getElementById("perfWASM");

    let original = null;
    let adjust_hsv = null;
    let wasmReady = false;

    function setupWASM() {
      adjust_hsv = Module.cwrap("adjust_hsv", "void", ["number","number","number","number","number"]);
      wasmReady = true;
      perfWASM.textContent = "âœ… WASM ì¤€ë¹„ ì™„ë£Œ";
      perfWASM.classList.remove("warn");
      perfWASM.classList.add("ok");
    }

    imgInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        // ì›ë³¸ í¬ê¸°ëŠ” ìœ ì§€í•˜ë˜, í‘œì‹œë§Œ CSSë¡œ ì¶•ì†Œ
        canvasJS.width = canvasWASM.width = img.width;
        canvasJS.height = canvasWASM.height = img.height;
        ctxJS.drawImage(img, 0, 0);
        ctxWASM.drawImage(img, 0, 0);
        original = ctxJS.getImageData(0, 0, img.width, img.height);
        perfJS.textContent = "JS ì²˜ë¦¬ì‹œê°„: -";
        perfWASM.textContent = "WASM ì²˜ë¦¬ì‹œê°„: -";
      };
      img.src = URL.createObjectURL(file);
    });

    [hue, sat, val].forEach(sl => sl.addEventListener("input", onSliderChange));

    function onSliderChange() {
      if (!original) return;
      hueVal.textContent = `${hue.value}Â°`;
      satVal.textContent = `${sat.value}%`;
      valVal.textContent = `${val.value}%`;
      updateJS();
      updateWASM();
    }

    function updateJS() {
      const hueShift = hue.value / 360;
      const satScale = sat.value / 100;
      const valScale = val.value / 100;
      const data = new Uint8ClampedArray(original.data);

      const t0 = performance.now();
      for (let i = 0; i < data.length; i += 4) {
        let r = data[i] / 255, g = data[i+1] / 255, b = data[i+2] / 255;
        const max = Math.max(r,g,b), min = Math.min(r,g,b), d = max-min;
        let h=0,s=0,v=max;
        if (d!==0) {
          s = d/max;
          switch(max){
            case r: h=((g-b)/d+(g<b?6:0))/6; break;
            case g: h=((b-r)/d+2)/6; break;
            case b: h=((r-g)/d+4)/6; break;
          }
        }
        h=(h+hueShift)%1; s=Math.min(s*satScale,1); v=Math.min(v*valScale,1);
        const c=v*s, x=c*(1-Math.abs(((h*6)%2)-1)), m=v-c;
        let r1=0,g1=0,b1=0;
        if(h<1/6)[r1,g1,b1]=[c,x,0];
        else if(h<2/6)[r1,g1,b1]=[x,c,0];
        else if(h<3/6)[r1,g1,b1]=[0,c,x];
        else if(h<4/6)[r1,g1,b1]=[0,x,c];
        else if(h<5/6)[r1,g1,b1]=[x,0,c];
        else [r1,g1,b1]=[c,0,x];
        data[i]=(r1+m)*255; data[i+1]=(g1+m)*255; data[i+2]=(b1+m)*255;
      }
      const t1 = performance.now();
      ctxJS.putImageData(new ImageData(data, original.width, original.height), 0, 0);
      perfJS.textContent = `JS ì²˜ë¦¬ì‹œê°„: ${(t1 - t0).toFixed(2)} ms`;
    }

    function updateWASM() {
      if (!wasmReady || !original) return;
      const hueShift = hue.value / 360;
      const satScale = sat.value / 100;
      const valScale = val.value / 100;
      const len = original.data.length;

      const t0 = performance.now();
      const ptr = Module._malloc(len);
      const heap = new Uint8Array(HEAPU8.buffer, ptr, len);
      heap.set(original.data);
      adjust_hsv(ptr, len, hueShift, satScale, valScale);
      const out = new Uint8ClampedArray(len);
      out.set(heap);
      Module._free(ptr);
      const t1 = performance.now();

      ctxWASM.putImageData(new ImageData(out, original.width, original.height), 0, 0);
      perfWASM.textContent = `WASM ì²˜ë¦¬ì‹œê°„: ${(t1 - t0).toFixed(2)} ms`;
    }
  </script>
</body>
</html>
