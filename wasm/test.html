<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WASM HSV ì¡°ì • (ìµœì¢…ë³¸)</title>
  <style>
    body { font-family: system-ui, sans-serif; text-align:center; margin:20px; }
    canvas { border:1px solid #0002; margin-top:10px; max-width:100%; }
    .controls { margin-top:20px; display:flex; flex-direction:column; align-items:center; gap:10px; }
    label { display:flex; align-items:center; gap:10px; min-width:320px; }
    input[type="range"] { width:220px; }
    .perf { margin-top:10px; font-size:14px; color:#555; }
    .ok { color:#1a7f37; } .warn { color:#b54708; } .muted { opacity:.6; }
    input[disabled] { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <h2>WebAssemblyë¡œ HSV ì¡°ì •</h2>

  <div class="controls muted" id="controls">
    <input type="file" id="imgInput" accept="image/*" disabled />
    <label>Hue
      <input type="range" id="hue" min="0" max="360" value="0" disabled />
      <span id="hueVal">0Â°</span>
    </label>
    <label>Saturation
      <input type="range" id="sat" min="0" max="200" value="100" disabled />
      <span id="satVal">100%</span>
    </label>
    <label>Value
      <input type="range" id="val" min="0" max="200" value="100" disabled />
      <span id="valVal">100%</span>
    </label>
  </div>

  <canvas id="canvas"></canvas>
  <div id="status" class="perf warn">WASM ë¡œë”© ì¤‘â€¦</div>
  <div id="perf" class="perf">-</div>

  <!-- ì „ì—­ Moduleì„ ë¯¸ë¦¬ ì •ì˜: emscriptenì´ ì´ ê°ì²´ë¥¼ ì¬ì‚¬ìš© -->
  <script>
    var Module = {
      onRuntimeInitialized() {
        console.log("âœ… WASM Runtime Initialized");
        setupUI();
      }
    };
  </script>

  <!-- emscripten glue (ìºì‹œ ë¬´ë ¥í™” ì¿¼ë¦¬ ì¶”ê°€) -->
  <script>document.write(`<script src="hsv.js?v=${Date.now()}"><\/script>`);</script>

  <script>
    // DOM refs
    const controls = document.getElementById("controls");
    const imgInput = document.getElementById("imgInput");
    const hue = document.getElementById("hue");
    const sat = document.getElementById("sat");
    const val = document.getElementById("val");
    const hueVal = document.getElementById("hueVal");
    const satVal = document.getElementById("satVal");
    const valVal = document.getElementById("valVal");
    const statusEl = document.getElementById("status");
    const perfEl = document.getElementById("perf");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    let original = null;
    let adjust_hsv = null;

    function setupUI() {
      // cwrapìœ¼ë¡œ C í•¨ìˆ˜ ë°”ì¸ë”©
      adjust_hsv = Module.cwrap("adjust_hsv", "void", ["number","number","number","number","number"]);

      // ğŸ”‘ HEAPU8ì€ ì „ì—­ ë³€ìˆ˜(ëª¨ë“ˆ ë°–)ë‹¤. Module.HEAPU8ì´ ì•„ë‹ˆë‹¤!
      if (typeof HEAPU8 === "undefined") {
        console.error("HEAPU8 ì „ì—­ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¹Œë“œê°€ MODULARIZE=1ë¡œ ë˜ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸.");
        statusEl.textContent = "âŒ HEAPU8 ë¯¸ë…¸ì¶œ (ë¹Œë“œ ì˜µì…˜ í™•ì¸)";
        return;
      }

      // UI í™œì„±í™”
      [imgInput, hue, sat, val].forEach(el => el.disabled = false);
      controls.classList.remove("muted");
      statusEl.textContent = "âœ… WASM ì¤€ë¹„ ì™„ë£Œ";
      statusEl.classList.remove("warn"); statusEl.classList.add("ok");

      // ì´ë²¤íŠ¸ ë“±ë¡ (ì´ˆê¸°í™” ì´í›„ì—ë§Œ)
      imgInput.addEventListener("change", onImageSelect);
      [hue, sat, val].forEach(sl => sl.addEventListener("input", onSliderInput));
    }

    function onImageSelect(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        original = ctx.getImageData(0, 0, canvas.width, canvas.height);
        console.log("âœ… ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ");
      };
      img.src = URL.createObjectURL(file);
    }

    function onSliderInput() {
      hueVal.textContent = `${hue.value}Â°`;
      satVal.textContent = `${sat.value}%`;
      valVal.textContent = `${val.value}%`;
      updateImage();
    }

    function updateImage() {
      if (!original) return;

      const hueShift = Number(hue.value) / 360;
      const satScale = Number(sat.value) / 100;
      const valScale = Number(val.value) / 100;

      const t0 = performance.now();
      const out = applyHSV_WASM(original, hueShift, satScale, valScale);
      const t1 = performance.now();

      ctx.putImageData(out, 0, 0);
      perfEl.textContent = `WASM ì²˜ë¦¬ ì‹œê°„: ${(t1 - t0).toFixed(2)} ms`;
    }

    function applyHSV_WASM(srcImageData, hueShift, satScale, valScale) {
      const { width, height, data: src } = srcImageData;
      const len = src.length;

      // ğŸ”‘ ì—¬ê¸°ì„œë„ ì „ì—­ HEAPU8ì„ ì‚¬ìš©í•œë‹¤ (Module.HEAPU8 ì•„ë‹˜!)
      if (typeof HEAPU8 === "undefined" || !HEAPU8.buffer) {
        console.error("âŒ HEAPU8ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return srcImageData;
      }

      const ptr = Module._malloc(len);
      try {
        const heap = new Uint8Array(HEAPU8.buffer, ptr, len);
        heap.set(src);
        adjust_hsv(ptr, len, hueShift, satScale, valScale);
        const out = new Uint8ClampedArray(len);
        out.set(heap);
        return new ImageData(out, width, height);
      } finally {
        Module._free(ptr);
      }
    }
  </script>
</body>
</html>
